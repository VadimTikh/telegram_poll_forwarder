# Telegram Poll Forwarder

Демон, который мониторит Telegram-группу на наличие новых опросов, пересылает их в личный чат и инициирует телефонный звонок через Binotel.

## Что делает

1. Подключается к Telegram через личный аккаунт (userbot на базе gramjs)
2. Отслеживает новые опросы в указанной группе
3. Пересылает опрос в выбранный чат (по умолчанию — «Избранное»)
4. Отправляет текстовое уведомление с вопросом и вариантами ответа
5. Инициирует телефонный звонок через API Binotel

## Требования

- Node.js 18+
- npm
- PM2 (для деплоя в продакшн): `npm install -g pm2`

## Получение Telegram API credentials

1. Перейдите на [my.telegram.org](https://my.telegram.org)
2. Авторизуйтесь с номером телефона
3. Перейдите в «API development tools»
4. Создайте приложение и скопируйте `api_id` и `api_hash`

## Установка

```bash
# Клонируйте репозиторий
cd D:\Projects\telegram_voting_app

# Установите зависимости
npm install

# Создайте файл конфигурации
cp .env.example .env

# Заполните .env своими данными
```

## Конфигурация (.env)

| Переменная | Описание | Обязательная |
|---|---|---|
| `TG_API_ID` | API ID из my.telegram.org | Да |
| `TG_API_HASH` | API Hash из my.telegram.org | Да |
| `TG_PHONE_NUMBER` | Номер телефона (напр. +380991234567) | Да |
| `TG_SOURCE_GROUP` | Username или ID группы-источника | Да |
| `TG_DESTINATION_CHAT` | Чат для пересылки (по умолчанию: `me`) | Нет |
| `BINOTEL_API_KEY` | API ключ Binotel | Да |
| `BINOTEL_API_SECRET` | API секрет Binotel | Да |
| `BINOTEL_EXTENSION` | Внутренний номер Binotel | Да |
| `CALL_PHONE_NUMBER` | Телефон для звонка | Да |
| `CALL_COOLDOWN_SECONDS` | Кулдаун между звонками (по умолчанию: 60) | Нет |

## Первый запуск (авторизация)

**Важно:** первый запуск должен быть интерактивным для прохождения авторизации Telegram.

```bash
npm run dev
```

1. Введите код, полученный в Telegram
2. Если включена 2FA — введите пароль
3. После успешной авторизации сессия сохранится в `session.txt`
4. Последующие запуски не будут запрашивать авторизацию

## Деплой через PM2

```bash
# Скомпилируйте TypeScript
npm run build

# Запустите через PM2
npm run pm2:start

# Просмотр логов
npm run pm2:logs

# Остановка
npm run pm2:stop
```

## Команды

| Команда | Описание |
|---|---|
| `npm run dev` | Запуск в режиме разработки (ts-node) |
| `npm run build` | Компиляция TypeScript |
| `npm start` | Запуск скомпилированного приложения |
| `npm run pm2:start` | Запуск через PM2 |
| `npm run pm2:stop` | Остановка PM2 |
| `npm run pm2:logs` | Просмотр логов PM2 |

## Устранение неполадок

### «Missing required environment variable»
Убедитесь, что файл `.env` существует и все обязательные переменные заполнены.

### Ошибка авторизации Telegram
- Проверьте правильность `TG_API_ID` и `TG_API_HASH`
- Убедитесь, что номер телефона указан в международном формате
- Удалите `session.txt` и пройдите авторизацию заново: `npm run dev`

### Опросы не пересылаются
- Проверьте, что `TG_SOURCE_GROUP` указан верно (username без @, или числовой ID)
- Убедитесь, что аккаунт является участником группы
- Проверьте логи: `logs/app.log`

### Binotel не звонит
- Проверьте API-ключи Binotel
- Убедитесь, что внутренний номер (extension) существует
- Проверьте формат телефона
- Если `make-call.json` не работает, возможно, нужен эндпоинт `ext-to-phone.json`

### PM2 не запускается
Убедитесь, что:
1. Проект скомпилирован: `npm run build`
2. Авторизация пройдена (существует `session.txt`)
3. PM2 установлен глобально: `npm install -g pm2`
